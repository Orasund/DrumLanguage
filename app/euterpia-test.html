<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Elm-Euterpia Test</title>
  <script src="EuterpiaTest.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/13.0.1/Tone.min.js" ></script>
</head>

<body>
  <div id="elm"></div>
  <script>
      var app = Elm.Example.init({
        node: document.getElementById('elm')
      });

      var bpm = 120


      app.ports.sendMusic.subscribe(function(eventArray) {

        console.log("JSON: " + JSON.stringify(eventArray))

        console.log("Play at " + bpm + " bpm")
        var synth = new Tone.Synth().toMaster()
        //pass in an array of events
        var part = new Tone.Part(function(time, event){
        	  synth.triggerAttackRelease(event.note, event.dur, time)
          }, eventArray
        )

      part.start(Tone.now())
      part.loop = 0
        part.loopEnd = '1m'


        Tone.Transport.bpm.value = bpm
        Tone.Transport.start();

      })

      app.ports.sendCommand.subscribe(function(command) {

        var args = command.split(":")

        console.log("ARGS: " + args)

        if (args[0] == "tempo") {
           console.log("tempo = " + args[1] + " bpm")
           bpm = parseInt(args[1])
           Tone.Transport.bpm.value = bpm
        } else if (args[0] == "stop") {
        Tone.Transport.cancel();
        }

      })

  </script>

</body>
</html>
